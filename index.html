<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Comet Simulation</title>
  <style>
    #cometButtons button {
  background-color: #444;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 6px 10px;
  font-size: 13px;
  cursor: pointer;
}

#cometButtons button:hover {
  background-color: #666;
}
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      background-color: black;
    }

    #renderCanvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    #uiOverlay {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      color: white;
      font-family: sans-serif;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 12px;
      border-radius: 8px;
      max-width: 300px;
    }

    #uiOverlay label {
      display: block;
      margin-top: 6px;
      font-size: 14px;
    }

      #uiOverlay input[type="range"],
      #uiOverlay input[type="number"],
      #uiOverlay input[type="text"],
      #uiOverlay select {
        width: 100%;
        margin-bottom: 6px;
      }

    button {
      margin-top: 10px;
      padding: 6px 12px;
      font-size: 14px;
      background-color: #444;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }

    button:hover {
      background-color: #666;
    }

    .comet-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }

    .comet-buttons button {
      width: auto;
      font-size: 12px;
      padding: 4px 8px;
    }

:root{
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-right: env(safe-area-inset-right, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-left: env(safe-area-inset-left, 0px);
}

#renderCanvas{
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100dvh;
}

#homeScreen{
  padding-top: calc(20px + var(--safe-top)) !important;
  padding-left: calc(20px + var(--safe-left)) !important;
  padding-right: calc(20px + var(--safe-right)) !important;
  height: 100dvh !important;
}

@media (max-width: 900px){
  html, body{
    overflow: auto;
    height: 100%;
    background: #000;
  }

  #uiOverlay{
    position: fixed;
    top: calc(10px + var(--safe-top));
    left: calc(10px + var(--safe-left));
    right: calc(10px + var(--safe-right));
    max-width: none;
    max-height: min(55vh, calc(100dvh - 140px));
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }

  #betaCurvePanel{
    position: fixed !important;
    right: calc(10px + var(--safe-right));
    left: calc(10px + var(--safe-left));
    bottom: calc(80px + var(--safe-bottom));
    top: auto;
    width: auto;
    max-width: 640px;
    max-height: 38vh;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }

  #simTimeDisplay{
    top: calc(10px + var(--safe-top)) !important;
  }
  #statusContainer{
    top: calc(10px + var(--safe-top)) !important;
    right: calc(10px + var(--safe-right)) !important;
  }
  #pauseContainer{
    top: calc(48px + var(--safe-top)) !important;
    right: calc(10px + var(--safe-right)) !important;
  }

  #axisControl{
    right: calc(10px + var(--safe-right)) !important;
    bottom: calc(260px + var(--safe-bottom)) !important;
    top: auto !important;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(4px);
  }
  #cometButtons{
    right: calc(10px + var(--safe-right)) !important;
    bottom: calc(200px + var(--safe-bottom)) !important;
    top: auto !important;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(4px);
  }

  #fpsCounter,
  #particleCounter,
  #actBoxQ,
  #actBoxDecay{
    right: calc(10px + var(--safe-right)) !important;
  }
  #timelineWrapper{
    padding-bottom: calc(10px + var(--safe-bottom));
  }

  #uiOverlay, #betaCurvePanel{ font-size: 0.95rem; }
  #uiOverlay input, #uiOverlay select, #uiOverlay button{ font-size: 0.9rem; }
}

@media (max-width: 480px){
  .comet-buttons{ grid-template-columns: 1fr; }
  #betaCurvePanel{ max-height: 34vh; }
}

  </style>
</head>
<body>

  <div id="homeScreen" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: #000814;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  color: white;
  font-family: Arial, sans-serif;
">
  <h1 style="font-size: 64px; margin: 0;">Comet Simulator</h1>
  <button id="startBtn" style="
    margin-top: 30px;
    padding: 15px 40px;
    font-size: 24px;
    background-color: #1d3557;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  ">Click to start</button>

  <div id="loadingSpinner" style="
    margin-top: 30px;
    border: 6px solid #ccc;
    border-top: 6px solid #1d3557;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    display: none;
  "></div>
</div>

<canvas id="renderCanvas"></canvas>

<div id="simTimeDisplay" style="
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-size: 28px;
  font-weight: bold;
  z-index: 1000;
  font-family: sans-serif;
  text-shadow: 0 0 5px black;
">
  Time: --
  
</div>

<style>
#timelineWrapper {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(0, 0, 0, 0.7);
  padding: 10px 20px;
  font-family: sans-serif;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

#topRow {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  gap: 15px;
  padding-left: 10px;
}

#timelineLabel {
  font-weight: bold;
  color: white;
  font-size: 1.2em;
}

#timelineSlider {
  width: 95%;
  cursor: pointer;
}

</style>

<div id="timelineWrapper">
  <div id="topRow">
    <div id="timelineLabel">Date: 2000-01-01</div>
  </div>
  <input type="range" id="timelineSlider" min="-36525" max="36525" value="0" step="1" disabled />
</div>

  <div id="uiOverlay">

    <label for="eccentricityInput">Eccentricity (e):</label>
    <input type="number" id="eccentricityInput" step="0.0001" min="0" max="10" value="0.64090813" />

    <label for="perihelionInput">Perihelion Distance (AU):</label>
    <input type="number" id="perihelionInput" step="0.0001" min="0.1" value="1.24326564" />

    <label for="inclinationInput">Inclination (°):</label>
    <input type="number" id="inclinationInput" step="0.01" value="7.04029491" />

    <label for="longitudeAscendingNodeInput">Longitude of Ascending Node (Ω, °):</label>
    <input type="number" id="longitudeAscendingNodeInput" step="0.01" value="50.135573804414" />

    <label for="argumentPerihelionInput">Argument of Perihelion (ω, °):</label>
    <input type="number" id="argumentPerihelionInput" step="0.01" value="12.798249734157" />

    <label for="perihelionDateInput">Perihelion Date:</label>
    <input type="number" id="perihelionDateInput" step="0.1" value="2457247.5887" />
    
    <label for="particleLifetimeInput">Particle Lifetime:</label>
    <input type="number" id="particleLifetimeInput" step="100" min="1000" value="400" />

    <label>
      Activity exponent n (Q = k / r^n):
      <input id="activityExponentInput" type="number" step="0.1" min="0" max="6" value="4">
    </label>
    <label>
      Activity scale k @ 1 AU:
      <input id="activityScaleInput" type="number" step="0.1" min="0" value="1">
    </label>

<div class="activity-field">
  <label for="activityHalfLifeInput">Activity decay half-life (e-days):</label>
  <input id="activityHalfLifeInput" type="number" step="10" min="1" value="1500">
</div>

<div class="activity-field">
  <label for="activityExponentInput">Activity exponent n (Q = k / r^n):</label>
  <input id="activityExponentInput" type="number" step="0.1" min="0" max="6" value="4">
</div>

<div class="activity-field">
  <label for="activityScaleInput">Activity scale k @ 1 AU:</label>
  <input id="activityScaleInput" type="number" step="0.1" min="0" value="1">
</div>

  <label for="particleCountInput">Particle Count (per sec):</label>
  <input type="number" id="particleCountInput" step="1" min="1" max="3000" value="100" />

<label for="visModeSelect">Particle color:</label>
<select id="visModeSelect">
  <option value="none">None</option>
  <option value="beta">β value</option>
  <option value="age">Age</option>
  <option value="dist">Distance from nucleus</option>
  <option value="vrel">Relative velocity</option>
</select>

  <label for="velocitySlider">Simulation speed: <span id="velocityValue">1</span></label>
  <input type="range" id="velocitySlider" min="0" max="100" value="0" step="1">

<div id="orbitControls" style="
  position: absolute;
  top: 650px;
  right: 65px;
  z-index: 15;
  display: flex;
  flex-direction: column;
  gap: 10px;
  font-family: sans-serif;
">
</div>
  <button style="
    background: none;
    border: 1.5px solid #ccc;
    color: #eee;
    padding: 6px 2px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  " id="toggleOrbitBtn">Toggle Orbit</button>

  <button style="
    background: none;
    border: 1.5px solid #ccc;
    color: #eee;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  " id="toggleFocusBtn">Focus on Comet</button>

  <button style="
    background: none;
    border: 1.5px solid #ccc;
    color: #eee;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  " id="updateViewBtn" disabled>Update Position</button>

</div>
  </div>

<div id="statusContainer" style="
  position: fixed;
  top: 10px;
  right: 25px;
  z-index: 1001;
  font-family: sans-serif;
">
  <div id="gpuStatus" style="
    font-size:12px;
    padding:4px 6px;
    border-radius:4px;
    background:#222;
    color:#eee;
    border:1px solid #555;
    opacity:0.9;
    display:inline-block;
  ">GPU: —</div>
</div>

<div id="pauseContainer" style="
  position: fixed;
  top: 110px;
  right: 25px;
  z-index: 1000;
  padding: 10px 20px;
  border-radius: 8px;
  font-family: sans-serif;
">
  <button id="pauseBtn" style="
    background: none;
    border: 1.5px solid #ccc;
    color: #eee;
    padding: 8px 16px;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  ">Pause</button>
</div>

<div id="axisControl" style="
  position: fixed;
  top: 170px;
  right: 20px;
  z-index: 15;
  padding: 6px;
  border-radius: 6px;
  display: flex;
  flex-direction: row;
  gap: 10px;
  font-family: sans-serif;
  background: transparent;
  width: max-content;
">
  <button style="
    background: none;
    border: 1.5px solid #ccc;
    color: #eee;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  " onclick="setViewAxis('X')">X</button>

  <button style="
    background: none;
    border: 1.5px solid #ccc;
    color: #eee;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  " onclick="setViewAxis('Y')">Y</button>

  <button style="
    background: none;
    border: 1.5px solid #ccc;
    color: #eee;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  " onclick="setViewAxis('Z')">Z</button>
</div>

<div id="cometButtons" style="
  position: fixed;
  top: 220px;
  right: 30px;
  z-index: 15;
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 8px;
  border-radius: 6px;
  font-family: sans-serif;
  background: transparent;
">
  <button style="
    background: none;
    border: 1.5px solid #ccc;
    color: #eee;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  " onclick="loadComet('67P')">67P</button>

  <button style="
    background: none;
    border: 1.5px solid #ccc;
    color: #eee;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  " onclick="loadComet('C2024E1')">C/2024 E1</button>

  <button style="
    background: none;
    border: 1.5px solid #ccc;
    color: #eee;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  " onclick="loadComet('133P')">133P</button>

  <button style="
    background: none;
    border: 1.5px solid #ccc;
    color: #eee;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  " onclick="loadComet('3I')">3I/ATLAS</button>
</div>

<div id="actBoxQ" style="
  position: fixed;
  bottom: 190px;   /* ~46px above particle counter */
  right: 20px;
  z-index: 1002;
  font-family: monospace, sans-serif;
  font-size: 14px;
  color: #fff;
  background: rgba(0,0,0,0.6);
  padding: 4px 8px;
  border-radius: 4px;
  border: 1px solid #fff;
  display: inline-block;
  white-space: nowrap;
">Q: --</div>

<div id="actBoxDecay" style="
  position: fixed;
  bottom: 150px;
  right: 20px;
  z-index: 1002;
  font-family: monospace, sans-serif;
  font-size: 14px;
  color: #fff;
  background: rgba(0,0,0,0.6);
  padding: 4px 8px;
  border-radius: 4px;
  border: 1px solid #fff;
  display: inline-block;
  white-space: nowrap;
">decay: --</div>

<div id="particleCounter" style="
  position: fixed;
  bottom: 110px;
  right: 20px;
  z-index: 1001;
  font-family: monospace, sans-serif;
  font-size: 14px;
  color: #fff;
  background: rgba(0,0,0,0.6);
  padding: 4px 8px;
  border-radius: 4px;
  border: 1px solid #fff;
">
  Particles: --
</div>

<div id="fpsCounter" style="
  position: fixed;
  bottom: 70px;
  right: 20px;
  z-index: 1001;
  font-family: monospace, sans-serif;
  font-size: 14px;
  color: #fff;
  background: rgba(0,0,0,0.6);
  padding: 4px 8px;
  border-radius: 4px;
  border: 1px solid #fff;
">
  FPS: --
</div>

<div id="betaCurvePanel" style="
  position: fixed;
  right: 20px;
  top: 500px;
  width: 340px;
  z-index: 1010;
  font-family: Inter, system-ui, sans-serif;
  color: #e7f0ff;
  background: linear-gradient(180deg, rgba(11, 14, 19, 0.85), rgba(12,16,22,0.85));
  border: 1px solid rgba(120,150,180,0.35);
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.06);
  backdrop-filter: blur(6px);
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 10px 12px 12px 12px;
">
<div style="display:flex; align-items:center; justify-content:space-between;">
  <div style="font-size:16px; font-weight:600; letter-spacing:0.2px; opacity:.9;">
    β Gradation Curve
  </div>
  <div style="display:flex; gap:6px; align-items:center;">
  </div>
</div>

  <div style="position:relative;">
    <canvas id="betaCurveCanvas"
      width="340" height="260"
      style="width:340px;height:260px; background:#0a1016; border-radius:10px; border:1px solid rgba(70,100,130,0.5);">
    </canvas>

    <div id="betaCurveTip" style="
      position:absolute; pointer-events:none; transform:translate(-50%,-120%);
      background: rgba(12,18,26,0.9); color:#dff3ff; font-size:11px;
      padding: 4px 6px; border-radius:6px; border:1px solid rgba(130,160,190,0.4);
      box-shadow: 0 2px 10px rgba(0,0,0,0.4); display:none;">
      β: 0.00 • w: 0.00
    </div>
  </div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
  <script src="https://cdn.babylonjs.com/webgpu/babylon.webgpu.min.js"></script>

  <script src="./main.patched.js"></script>

<script>
  function loadComet(id) {

const comets = {
  "67P": {
    solutions: [
      {
        e: 0.64090813,
        q: 1.24326564,
        i: 7.04029491,
        omega: 50.135573804414,
        w: 12.798249734157,
        T: 2457247.5887
      }
    ]
  },

  "C2024E1": {
    solutions: [{ e: 1.00048372, q: 0.56171583, i: 75.21807230, omega: 108.38859762573, w: 243.65164937935, T: 2461060.9651 }]
  },
  "133P": {
    solutions: [{ e: 0.15637284, q: 2.67049635, i: 1.38981783, omega: 160.09954075742, w: 131.90192411846, T: 2460440.7000 }]
  },
  "3I": {
    solutions: [{ e: 6.13941774, q: 1.35638454, i: 175.11310480, omega: 322.15684249105, w: 128.01051366675, T: 2460977.9814 }]
  }
};

window.currentPresetId = id;

function pickSolutionForJD(solutions, jd) {
  if (!Array.isArray(solutions) || solutions.length === 0) return null;
  let best = solutions[0], bestAbs = Math.abs((solutions[0].T ?? 0) - jd);
  for (let k = 1; k < solutions.length; k++) {
    const d = Math.abs((solutions[k].T ?? 0) - jd);
    if (d < bestAbs) { best = solutions[k]; bestAbs = d; }
  }
  return best;
}
    const displayName = {
      "67P": "67P/Churyumov–Gerasimenko",
      "C2024E1": "C/2024 E1",
      "133P": "133P/Elst–Pizarro",
      "3I": "3I/ATLAS"
    }[id];

const pack = comets[id];
if (!pack) return;

const nowJD = (window.simulationTimeJD ?? (pack.solutions[0]?.T ?? 2451544.5));
const sol = pickSolutionForJD(pack.solutions, nowJD);
if (!sol) return;

document.getElementById('eccentricityInput').value = sol.e;
document.getElementById('perihelionInput').value  = sol.q;
document.getElementById('inclinationInput').value = sol.i;
document.getElementById('longitudeAscendingNodeInput').value = sol.omega;
document.getElementById('argumentPerihelionInput').value     = sol.w;
document.getElementById('perihelionDateInput').value         = sol.T;

window.updateOrbitParameters?.();

const daysBeforeT = 400;
const jdStart = sol.T - daysBeforeT;
window.setSimTime?.(jdStart, { resetParticles: true, focus: !window._skipInitialFocus });

window._skipInitialFocus = false;

    window.switchToPreset?.(displayName || id);
  }
</script>

  <script>
  document.getElementById("startBtn").addEventListener("click", () => {
    const spinner = document.getElementById("loadingSpinner");
    spinner.style.display = "block";

    setTimeout(() => {
      document.getElementById("homeScreen").style.display = "none";
      startSimulation();
    }, 300);
  });
</script>
</body>
</html>
